var greenicon=L.icon({iconUrl:"libs/leaflet/images/marker-icon-green.png",iconSize:[25,40],iconAnchor:[12,40],shadowSize:[40,40]});
jQuery(document).ready(function(){function y(){var a=new L.TileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),b=new L.Google("ROADMAP"),c=new L.Google,d=new L.TileLayer.WMS("http://148.251.4.143/cgi-bin/ubc_ocorrencias/qgis_mapserv.fcgi",{layers:"grelha UTM 10km",format:"image/png",transparent:"TRUE"}),e=new L.TileLayer.WMS("http://148.251.4.143/cgi-bin/ubc_ocorrencias/qgis_mapserv.fcgi",{layers:"grelha UTM 2km",format:"image/png",transparent:"TRUE"});window.map=L.map("map",{scrollWheelZoom:!1});
map.blueMarker=[];map.greenMarker=[];map.appLayers=[a,b,c,d,e];map.setView([39.704314,-8.127506],6);map.addLayer(a);L.control.layers({OSM:a,"Google Streets":b,"Google Satellite":c},{"Grelha 10 km":d,"Grelha 2 km":e}).addTo(map);map.on("accuratepositionprogress",z);map.on("accuratepositionfound",A);map.on("accuratepositionerror",B);map.on("click",h);L.easyButton("fa-crosshairs",function(){u()},"Geolocalizar");u();return map}function h(a){var b=k([a.latlng.lng,a.latlng.lat]);$("#xcoord").val(b[0]).parent().removeClass("has-error");
$("#ycoord").val(b[1]).parent().removeClass("has-error");0<map.greenMarker.length&&g(map.greenMarker);a=L.marker(a.latlng,{icon:greenicon});map.greenMarker.push(a);map.addLayer(a)}function p(a){$("#dialog-info").css("display","flex");$("#dialog-error").css("display","none");$("#dialog-progress").css("display","flex");$("#dialog-btn").css("display","none");$("#dialog").modal("toggle");$("#xcoord").val("");$("#ycoord").val("");$("#folha").val("");var b=k([a.latlng.lng,a.latlng.lat]);0<map.greenMarker.length&&
g(map.greenMarker);a=L.marker(a.latlng,{icon:greenicon});map.greenMarker.push(a);map.addLayer(a);$.ajax({type:"POST",url:"services/get_grid_coords.php",data:{x:b[0],y:b[1],grid:map.selectedGrid},dataType:"json",success:function(a){if(1==a.success){$("#xcoord").val(a.data[0].x).parent().removeClass("has-error");$("#ycoord").val(a.data[0].y).parent().removeClass("has-error");$("#folha").val(a.data[0].folha).parent().removeClass("has-error");a=k([a.data[0].x,a.data[0].y],"inverse");g(map.greenMarker);
var b=L.marker(a.reverse(),{icon:greenicon});map.greenMarker.push(b);map.addLayer(b);map.setView(a);12>map.getZoom()&&map.setZoom(12);$("#dialog").modal("toggle");$("#dialog-info").css("display","flex").html("A obter dados. Por favor aguarde...");$("#dialog-success").css("display","none");$("#dialog-progress").css("display","block");$("#dialog-error").css("display","none")}else $("#dialog-info").css("display","none"),$("#dialog-success").css("display","none"),$("#dialog-error").css("display","flex").html("Ocorreu um erro ao obter os dados! "+
a.msg),$("#dialog-progress").css("display","none"),$("#dialog-btn").css("display","block")}})}function g(a){for(var b=0;b<a.length;b++)map.removeLayer(a[b])}function u(){map.findAccuratePosition({maxWait:1E4,desiredAccuracy:20})}function B(a){a="Ocorreu um erro durante a geolocaliza\u00e7\u00e3o: "+a.message.split(": ")[1];0!=$("#gps").find(".alert-info").size()?$("#gps").find(".alert").removeClass("alert-info").removeClass("alert-success").addClass("alert-danger").html(a):$("#gps").find(".alert").removeClass("alert-warning").removeClass("alert-info").addClass("alert-danger").html(a)}
function z(a){$("#gps").find(".alert").removeClass("alert-warning").removeClass("alert-success").removeClass("alert-danger").addClass("alert-info").html("Geolocaliza\u00e7\u00e3o em progresso. Por favor aguarde.")}function A(a){0<map.blueMarker.length&&g(map.blueMarker);var b=k([a.latlng.lng,a.latlng.lat]);$("#gps").find(".alert").removeClass("alert-info").removeClass("alert-danger").addClass("alert-success").html("Geolocaliza\u00e7\u00e3o bem sucedida. Coordenadas UTM Zona 29N - <b>X: </b>"+Math.round(1E5*
b[0])/1E5+" m; <b>Y: </b>"+Math.round(1E5*b[1])/1E5+" m; <b>Precis\u00e3o: </b>"+Math.round(a.accuracy/2*100)/100+" m");map.setView(a.latlng,16);L.marker(a.latlng).addTo(map);b=Math.round(a.accuracy/2*100)/100;L.circle(a.latlng,b).addTo(map)}function k(a,b){return"inverse"==b?proj4("+proj=utm +zone=29 +datum=WGS84 +units=m +no_defs","+proj=longlat +datum=WGS84 +no_defs ",a):proj4("+proj=longlat +datum=WGS84 +no_defs ","+proj=utm +zone=29 +datum=WGS84 +units=m +no_defs",a)}function v(a,b){return 46==
a.which?-1!=$(b).val().indexOf(".")?!1:!0:8!=a.which&&0!=a.which&&(48>a.which||57<a.which)?!1:!0}function q(){var a={},b=$('input[name="obs"]:checked').val(),c=["phenology","age","sex","behavior"],d=["individuals","individuals_type"],e=["xcoord","ycoord"];if("exacta"==b)var f=["especie"].concat(c);else f=["sys_class","sys_class_val"],f=f.concat(w(c)),d=w(d);c=$('input[name="local-method"]:checked').val();"grid"==c&&(e=e.concat("folha"),a.localComboIds=["grid","biotopo"]);a.observation=b;a.comboIds=
f;a.sharedIndivualsIds=d;a.commonComboIds=["project","method","type"];a.dateTimeIds=["data","time"];a.localizationIds=e;a.method=c;return a}function r(a){for(var b=0,c=0;c<a.length;c++)null==$("#"+a[c]).select2("data")&&(b+=1,$("#"+a[c]).select2("container").css("border","1px solid rgba(185, 74, 72, .9)").css("border-radius","4px"));return b}function C(a){for(var b={},c=0;c<a.length;c++)b[a[c]]=$("#"+a[c]).val();return b}function D(a,b){var c={};c.dia=a._i.d;c.mes=a._i.M;c.ano=a._i.y;c.hora=b._d.getHours();
c.minutos=b._d.getMinutes();return c}function w(a){for(var b=0;b<a.length;b++)a[b]+="_aproximate";return a}function s(a){for(var b={},c=0;c<a.length;c++)if("especie"==a[c]){var d=$("#"+a[c]).select2("data").text,d=d.split(" | ");b.especie=d[0];b.nome_vulgar="";1<d.length&&(b.nome_vulgar=d[1])}else d=$("#"+a[c]).select2("data"),b[a[c]]=null==d?"":d.text;return b}function E(a){var b={};b.individuals=$("#"+a[0]).val();b.individuals_type=$('input[name="'+a[1]+'"]:checked').parent().text();return b}function l(a,
b){for(var c in b)a[c]=b[c];return a}function m(a){for(var b=0;b<a.length;b++)$("#"+a[b]).select2("val","")}function t(a){$("#"+a[0]).val("1");$('input[name="'+a[1]+'"]')[0].checked=!0}$("#form-tabs a").click(function(a){a.preventDefault();$(this).tab("show");"Localiza\u00e7\u00e3o"==this.innerHTML&&0==$("#map").hasClass("leaflet-container")&&y()});$('#observation input[name="obs"]').click(function(){for(var a=$('input[name="obs"]'),b=0;b<a.length;b++)1==a[b].checked&&("exacta"==a[b].value?($("#aproximate-form").css("display",
"none"),$("#exact-form").css("display","inline"),m("sys_class sys_class_val phenology_aproximate age_aproximate sex_aproximate behavior_aproximate".split(" ")),t(["individuals_aproximate","individuals_type_aproximate"])):($("#aproximate-form").css("display","inline"),$("#exact-form").css("display","none"),$("#sys_class_val").select2("enable",!1),$("#sys_class_val").select2("val",""),$("#sys_class").select2("val",""),m(["especie","phenology","age","sex","behavior"]),t(["individuals","individuals_type"])))});
$("#especie").select2({placeholder:"Seleccione a esp\u00e9cie observada",minimumInputLength:3,allowClear:!0,ajax:{url:"services/get_species.php",dataType:"json",data:function(a,b){return{especie:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#especie").on("select2-selecting",function(a){$("#especie").select2("container").css("border","none")});$("#sys_class").select2({placeholder:"Seleccione uma classe",allowClear:!0,ajax:{url:"services/get_species_fields.php",
dataType:"json",data:function(a,b){return{sys_class:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#sys_class").on("select2-selecting",function(a){$("#sys_class_val").select2("enable",!0).select2("val","");$("#sys_class").select2("container").css("border","none")}).on("select2-clearing",function(a){$("#sys_class_val").select2("enable",!1).select2("val","")});$("#sys_class_val").select2({placeholder:"Seleccione um valor",allowClear:!0,ajax:{url:"services/get_class_values.php",
dataType:"json",data:function(a,b){return{sys_class_val:$("#sys_class").select2("data").text,val:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#sys_class_val").on("select2-selecting",function(a){$("#sys_class_val").select2("container").css("border","none")});$("#phenology, #phenology_aproximate").select2({placeholder:"Seleccione uma fenologia",allowClear:!0,ajax:{url:"services/get_phenology.php",dataType:"json",data:function(a,b){return{phenology:a}},results:function(a){return"undefined"==
typeof a.length?{results:[]}:{results:a}}}});$("#phenology").on("select2-selecting",function(a){$("#phenology").select2("container").css("border","none")});$("#phenology_aproximate").on("select2-selecting",function(a){$("#phenology_aproximate").select2("container").css("border","none")});$("#age, #age_aproximate").select2({placeholder:"Seleccione a idade",allowClear:!0,ajax:{url:"services/get_ages.php",dataType:"json",data:function(a,b){return{age:a}},results:function(a){return"undefined"==typeof a.length?
{results:[]}:{results:a}}}});$("#age").on("select2-selecting",function(a){$("#age").select2("container").css("border","none")});$("#age_aproximate").on("select2-selecting",function(a){$("#age_aproximate").select2("container").css("border","none")});$("#sex, #sex_aproximate").select2({placeholder:"Seleccione o sexo",allowClear:!0,ajax:{url:"services/get_sex.php",dataType:"json",data:function(a,b){return{sex:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#sex").on("select2-selecting",
function(a){$("#sex").select2("container").css("border","none")});$("#sex_aproximate").on("select2-selecting",function(a){$("#sex_aproximate").select2("container").css("border","none")});$("#behavior, #behavior_aproximate").select2({placeholder:"Seleccione o comportamento",allowClear:!0,ajax:{url:"services/get_behavior.php",dataType:"json",data:function(a,b){return{behavior:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#behavior").on("select2-selecting",
function(a){$("#behavior").select2("container").css("border","none")});$("#behavior_aproximate").on("select2-selecting",function(a){$("#behavior_aproximate").select2("container").css("border","none")});$("input[name='individuals'], input[name='individuals_aproximate']").TouchSpin({max:1E3,min:1,buttondown_class:"btn btn-default btn-sm",buttonup_class:"btn btn-default btn-sm"});$("#project").select2({placeholder:"Seleccione o projecto",allowClear:!0,ajax:{url:"services/get_project.php",dataType:"json",
data:function(a,b){return{project:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#project").on("select2-selecting",function(a){$("#project").select2("container").css("border","none")});$("#method").select2({placeholder:"Seleccione o m\u00e9todo",allowClear:!0,ajax:{url:"services/get_method.php",dataType:"json",data:function(a,b){return{method:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#method").on("select2-selecting",
function(a){$("#method").select2("container").css("border","none")});$("#type").select2({placeholder:"Seleccione o m\u00e9todo",allowClear:!0,ajax:{url:"services/get_type.php",dataType:"json",data:function(a,b){return{type:a}},results:function(a){return"undefined"==typeof a.length?{results:[]}:{results:a}}}});$("#type").on("select2-selecting",function(a){$("#type").select2("container").css("border","none")});$("#data").datetimepicker({pickTime:!1,useCurrent:!1,showToday:!0});$("#data").on("dp.change",
function(a){$("#data").removeClass("has-error")});$("#time").datetimepicker({pickDate:!1});$("#time").on("dp.change",function(a){$("#time").removeClass("has-error")});$('#local input[name="local-method"]').click(function(){0<map.greenMarker.length&&g(map.greenMarker);var a=$('input[name="local-method"]:checked').val();"click"==a||"grid"==a?(map.on("click",h),$("#xcoord").attr("disabled",!0).val(""),$("#ycoord").attr("disabled",!0).val(""),$("#update-map").css("display","none")):(map.off("click",h),
$("#xcoord").attr("disabled",!1).val(""),$("#ycoord").attr("disabled",!1).val(""),$("#update-map").css("display","block"));"grid"==a?($("#map-aproximate").css("display","block"),$("#biotopo-section").css("display","block"),map.off("click",h)):($("#map-aproximate").css("display","none"),$("#biotopo-section").css("display","none"),$("#grid").select2("val",""))});$("#xcoord").keypress(function(a){return v(a,"#xcoord")});$("#xcoord").focusout(function(a){""!=$("#xcoord").val()&&$("#xcoord").parent().removeClass("has-error")});
$("#ycoord").keypress(function(a){return v(a,"#ycoord")});$("#ycoord").focusout(function(a){""!=$("#ycoord").val()&&$("#ycoord").parent().removeClass("has-error")});$("#update-map").click(function(){if(""!=$("#ycoord").val()&&""!=$("#xcoord").val()){var a=k([$("#xcoord").val(),$("#ycoord").val()],"inverse"),b=L.marker([a[1],a[0]],{icon:greenicon});map.greenMarker.push(b);map.addLayer(b);map.setView(a.reverse(),12)}});$("#grid").select2({placeholder:"Seleccione qual a grelha base",allowClear:!0,minimumResultsForSearch:-1,
data:[{id:1,text:"Grelha 10 km"},{id:2,text:"Grelha 2 km"}]});$("#grid").on("select2-selecting",function(a){1==a.val?(map.addLayer(map.appLayers[3]),map.removeLayer(map.appLayers[4]),map.selectedGrid=10):(map.addLayer(map.appLayers[4]),map.removeLayer(map.appLayers[3]),12>map.getZoom()&&map.setZoom(12),map.selectedGrid=2);map.off("click",p);map.on("click",p);0<map.greenMarker.length&&g(map.greenMarker);$("#xcoord").val("").parent().removeClass("has-error");$("#ycoord").val("").parent().removeClass("has-error");
$("#folha").val("").parent().removeClass("has-error");$("#grid").select2("container").css("border","none")}).on("select2-clearing",function(a){map.removeLayer(map.appLayers[3]);map.removeLayer(map.appLayers[4]);map.selectedGrid=null;map.off("click",p);$("#xcoord").val("");$("#ycoord").val("");$("#folha").val("")});$("#biotopo").select2({placeholder:"Seleccione um bi\u00f3topo",allowClear:!0,ajax:{url:"services/get_clc.php",dataType:"json",data:function(a,b){return{legend:a}},results:function(a){return"undefined"==
typeof a.length?{results:[]}:{results:a}}}});$("#validate").click(function(){var a=q(),b="O seu formul\u00e1rio n\u00e3o apresenta erros de preenchimento. Por favor carregue em submeter para enviar os dados.",c=!0;0<r(a.comboIds)&&(c=!1,b="O seu formul\u00e1rio apresenta erros de preenchimento nas seguintes sec\u00e7\u00f5es: <br>- Identifica\u00e7\u00e3o <br>");for(var d=r(a.commonComboIds),e=a.dateTimeIds,f=0,n=0;n<e.length;n++)if(null==$("#"+e[n]).data("DateTimePicker").getDate()||"undefined"==
typeof $("#"+e[n]).data("DateTimePicker").getDate()._i)f+=1,$("#"+e[n]).addClass("has-error");0<d+f&&(1==c&&(c=!1,b="O seu formul\u00e1rio apresenta erros de preenchimento nas seguintes sec\u00e7\u00f5es: <br>"),b+="- Caracteriza\u00e7\u00e3o <br>");d=a.localizationIds;for(f=e=0;f<d.length;f++)""==$("#"+d[f]).val()&&($("#"+d[f]).parent().addClass("has-error"),e+=1);d=e;if("grid"==a.method)var x=r([a.localComboIds[0]]);if(0<d||"undefined"!=typeof x&&0<x)1==c&&(c=!1,b="O seu formul\u00e1rio apresenta erros de preenchimento nas seguintes sec\u00e7\u00f5es: <br>"),
b+="- Localiza\u00e7\u00e3o <br>";$("#msg-alert").css("display","block");0==c?(b+="<br>Por favor corrija os seus dados e valide novamente o formul\u00e1rio!",$("#msg-alert").children().html(b).removeClass("alert-success").addClass("alert-danger")):($("#msg-alert").children().html(b).removeClass("alert-danger").addClass("alert-success"),$("#submit").removeAttr("disabled"))});$("#submit").click(function(){var a=q(),b=s(a.comboIds),c=E(a.sharedIndivualsIds),b=l(b,c);b.obs=a.observation;var c=s(a.commonComboIds),
d=D($("#data").data("DateTimePicker").getDate(),$("#time").data("DateTimePicker").getDate()),d=l(c,d);d.notas=$("#notas").val();c=C(a.localizationIds);if("grid"==a.method)var e=s(a.localComboIds),c=l(c,e);c.local_type=a.method;a=l(b,d);a=l(a,c);$("#dialog").modal("toggle");$("#dialog-info").css("display","flex").html("A submeter dados. Por favor aguarde...");$("#dialog-success").css("display","none");$("#dialog-progress").css("display","block");$("#dialog-error").css("display","none");$.ajax({type:"POST",
url:"services/new_observation.php",data:a,dataType:"json",success:function(a){if(1==a.success){$("#dialog-info").css("display","none");$("#dialog-success").css("display","flex");$("#dialog-progress").css("display","none");$("#dialog-btn").css("display","block");a=q();m(a.comboIds);t(a.sharedIndivualsIds);m(a.commonComboIds);for(var b=["data","time"],c=0;c<b.length;c++)$("#"+b[c]).data("DateTimePicker").setDate("");$("#notas").val("");b=a.localizationIds;for(c=0;c<b.length;c++)$("#"+b[c]).val("");
"undefined"!=typeof a.localComboIds&&m(a.localComboIds);$('#form-tabs a[href="#identification"]').tab("show");$('#observation input[name="obs"][value="exacta"]')[0].checked=!0;$("#aproximate-form").css("display","none");$("#exact-form").css("display","inline");g(map.greenMarker);map.off("click",h);map.off("click",p);map.on("click",h);$('#local input[name="local-method"][value="click"]')[0].checked=!0;$("#xcoord").attr("disabled",!0);$("#ycoord").attr("disabled",!0);$("#update-map").css("display",
"none");$("#map-aproximate").css("display","none");$("#biotopo-section").css("display","none");$("#submit").attr("disabled",!0);$("#msg-alert").css("display","none")}else $("#dialog-info").css("display","none"),$("#dialog-success").css("display","none"),$("#dialog-progress").css("display","none"),$("#dialog-error").css("display","flex").html("Ocorreu um erro ao obter os dados! "+a.msg),$("#dialog-btn").css("display","block")}})})});
